---
title: "Data_Exploration"
author: "Wendel Raymond"
date: "May 6, 2021"
output: html_document
editor_options: 
  chunk_output_type: console
---
## Strait of Juan de Fuca Data Exploration
This script will explore kelp cover and urchin data in the Strait of Juan de Fuca, Washington, USA. Goals are to look for general patterns and/or trends in kelp abundacne and sea urchin harvest.

```{r libraries, echo = FALSE, results = "hide", message = FALSE}
library(tidyverse)

theme_set(theme_classic())
```

### Data
1) Compiled DNR kelp canopy data from 1989 to 2016 georeferenced to WDFW shellfish management areas. Data were extracted from [Pfister et al 2018](https://besjournals.onlinelibrary.wiley.com/doi/full/10.1111/1365-2745.12908) and from publically available data at the Washington Department of Fish and Wildlife.

```{r data kelp, echo = FALSE, results = "hide"}
kelp <- read.csv("../Data/kelp_1989_2016_CatchArea_Ur.csv", header = TRUE, stringsAsFactors = FALSE)
```

2) WDFW Commercial Kelp harvest from 1973 to 2021. Harvest (pounds) by month, year, species, and catch area. Data were provided by WDFW.

```{r data urchin, echo = FALSE, results = "hide"}
urch <- read.csv("../Data/WDFW_RSU_GSU_pounds_annual_SJDF.csv", header = TRUE, stringsAsFactors = FALSE)
```


#### Data Management
Check data types and preform some transformations.

##### Kelp
Structure
```{r data mgmt kelp, echo = FALSE, results = "hide", message = FALSE}
## Check ##
str(kelp)

## Make character version of Map_Index ##
kelp$map_index_ch <- as.character(kelp$map_index)

## Fill blank FMAs (MCRA) and UID with values ##
kelp$MCRA_1 <- ifelse(kelp$MCRA_1 == " ", "U_MCRA", kelp$MCRA_1)
kelp$MCRA_2 <- ifelse(kelp$MCRA_2 == " ", "U_MCRA", kelp$MCRA_2)
kelp$UID <- ifelse(kelp$UID == " ", "U_UID", kelp$UID)

## Toggle LPEX or not ##
kelp$MCRA_2 <- ifelse(kelp$MCRA_2 == "LEX", "23C", kelp$MCRA_2)
```

Transformations
```{r trnsfm, echo = FALSE, results = "hide", message = FALSE}
## Convert to Meters ##
kelp$length_m <- kelp$length_ft * 0.3048
kelp$area_sqm <- kelp$area_sqft * 0.092903

## Convert to Hectare ##
kelp$area_hect <- kelp$area_sqm * 0.0001
```

##### WDFW Commercial Urchin

Structure
```{r data mgmt urch, echo = FALSE, results = "hide", message = FALSE}
## Check ##
str(urch)
```

Transformation
```{r}
## Convert to kg ##
urch$catch_kg <- urch$catch_lbs / 2.205
```

#### WDFW Urchin Fishing Areas
![](https://wdfw.wa.gov/sites/default/files/styles/page_body_full_width/public/2019-02/urchin.jpg?itok=rIFNmA9l)

#### Summarize kelp by Urchin Catch Area

Sum kelp area by year and UID
```{r sum1, echo = FALSE, message = FALSE}
kelp.sum <- kelp %>% 
  group_by(MCRA_2, year) %>% 
  summarise(total_kelp_hect = sum(area_hect)) %>% 
  mutate(UID_yroyr_mean = mean(total_kelp_hect),
         UID_yroyr_sd = sd(total_kelp_hect),
         total_kelp_anom = (total_kelp_hect - UID_yroyr_mean))
```

#### Summarize Urchin harvest by Catch Area
where we have kelp data
```{r sum2, echo = FALSE, message = FALSE}
urch.sum <- urch %>% 
  filter(catch_area == "23B" | catch_area == "23C" | catch_area == "23D" | catch_area == "29") %>% 
  group_by(catch_area, year) %>%
  summarise(total_urch_catch_kg = sum(catch_kg))
```

#### Assign catch areas to urchin fishing areas
Merge kelp and urchin data based off catch area. Kelp data uses 'MCRA_2' and urcin data uses 'catch_area'. MErge with all because there are years X areas with kelp data and no urchin data and vise versa.
```{r merge ur kelp, echo = FALSE, message = FALSE}
dat <- merge(kelp.sum, urch.sum, by.x = c("MCRA_2", "year"), by.y = c("catch_area", "year"), all = TRUE)

dat$total_urch_catch_kg[is.na(dat$total_urch_catch_kg)] <- 0
```

#### Plots

Plot - Total kelp area by year by catch area
```{r p1.1, echo = FALSE, message = FALSE}
ggplot(dat) +
  geom_line(aes(x = year, y = total_kelp_hect)) +
  facet_wrap(~MCRA_2)
```

Plot - Total urchin harvest by year by catch area
```{r p1.2, echo = FALSE, message = FALSE}
ggplot(dat) +
  geom_line(aes(x = year, y = log(total_urch_catch_kg))) +
  facet_wrap(~MCRA_2)
```

Plot - Urchin harvest by kelp canopy by catch area. Only where sea urch harvest is > 0.
```{r p1.3, = echo = FALSE, message= FALSE}
ggplot(subset(dat, dat$total_urch_catch_kg > 0)) +
  geom_point(aes(x = total_kelp_hect, y = log(total_urch_catch_kg), color = MCRA_2)) +
  scale_y_continuous(limits = c(0, 15), breaks = seq(0, 15, by = 3))
```

```{r p1.4, = echo = FALSE, message= FALSE}
ggplot(dat) +
  geom_point(aes(x = total_kelp_hect, y = log(total_urch_catch_kg))) +
  facet_wrap(~MCRA_2)
```


Plot - Year over year anomaly of total kelp area by catch area
```{r p1.2, echo = FALSE, message = FALSE}
ggplot(kelp.sum) +
  geom_line(aes(x = year, y = total_kelp_anom)) +
  geom_hline(yintercept = 0, linetype = "dashed") +
  facet_wrap(~UID)
```

Plots - Total Urchin harvest by year and catch areas 
```{r}
ggplot(urch.sum) +
  geom_line(aes(x = year, y = log(total_urch_catch_kg, base = 10))) +
  facet_wrap(~catch_area)
```


### Summarize kelp by species and Urchin Fishing Area

Sum kelp area by year, species, and UID
```{r sum2, echo = FALSE, message = FALSE}
kelp.sp.sum <- kelp %>%
  group_by(year, sp_name, UID) %>% 
  summarise(total_kelp_hect = sum(area_hect)) %>% 
  mutate(UID_yroyr_mean = mean(total_kelp_hect),
         UID_yroyr_sd = sd(total_kelp_hect),
         total_kelp_anom = (total_kelp_hect - UID_yroyr_mean))
```

Plot - Total kelp area by species and Urchin Fishing Area 
```{r p2.1, echo = FALSE}
ggplot(kelp.sp.sum) +
  geom_line(aes(x = year, y = total_kelp_hect, color = sp_name)) +
  facet_wrap(~UID)
```

### Summarize urchins harvest by 